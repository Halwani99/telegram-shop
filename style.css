const tg = window.Telegram.WebApp;

const products = [
  {id:1, name:"خاتم فاخر", price:"100,000 ل.س", image:"https://via.placeholder.com/200"},
  {id:2, name:"سوار نسائي", price:"50,000 ل.س", image:"https://via.placeholder.com/200"},
  {id:3, name:"عقد أسود", price:"75,000 ل.س", image:"https://via.placeholder.com/200"},
  {id:4, name:"ساعة أنيقة", price:"200,000 ل.س", image:"https://via.placeholder.com/200"}
];

let cart = [];

function renderProducts() {
  const container = document.getElementById("products-container");
  container.innerHTML = "";
  products.forEach(p=>{
    const div = document.createElement("div");
    div.className="product";
    div.innerHTML = `
      <img src="${p.image}" />
      <strong>${p.name}</strong>
      <p>${p.price}</p>
      <div>
        <button onclick="decrease(${p.id})">-</button>
        <span id="qty-${p.id}">0</span>
        <button onclick="increase(${p.id})">+</button>
      </div>
    `;
    container.appendChild(div);
  });
}

function increase(id){
  let item = cart.find(i=>i.id===id);
  if(!item){ 
    const prod = products.find(p=>p.id===id); 
    cart.push({...prod, qty:1});
  } else { item.qty++; }
  updateQty(id);
  updateCartCount();
}

function decrease(id){
  let item = cart.find(i=>i.id===id);
  if(item){
    item.qty--;
    if(item.qty<=0) cart = cart.filter(i=>i.id!==id);
    updateQty(id);
    updateCartCount();
  }
}

function updateQty(id){
  const item = cart.find(i=>i.id===id);
  document.getElementById(`qty-${id}`).innerText = item ? item.qty : 0;
}

function updateCartCount(){
  const total = cart.reduce((sum,i)=>sum+i.qty,0);
  document.getElementById("cart-count").innerText = total;
}

function toggleCart(){
  document.getElementById("cart-overlay").style.display = 
    document.getElementById("cart-overlay").style.display==="none" ? "block":"none";
  renderCart();
}

function renderCart(){
  const container = document.getElementById("cart-items");
  container.innerHTML="";
  cart.forEach(i=>{
    const div = document.createElement("div");
    div.innerHTML=`${i.name} x${i.qty} - ${i.price} <button onclick="removeFromCart(${i.id})">❌</button>`;
    container.appendChild(div);
  });
  const total = cart.reduce((sum,i)=>sum+i.qty*parseInt(i.price.replace(/,/g,"").replace(" ل.س","")),0);
  document.getElementById("cart-total").innerText = `المجموع: ${total.toLocaleString()} ل.س`;
}

function removeFromCart(id){
  cart = cart.filter(i=>i.id!==id);
  renderCart(); updateCartCount(); updateQty(id);
}

function checkout(){
  if(cart.length===0){ alert("السلة فارغة"); return; }
  document.getElementById("checkout-overlay").style.display="block";
  toggleCart();
}

function toggleCheckout(){
  document.getElementById("checkout-overlay").style.display=
    document.getElementById("checkout-overlay").style.display==="none" ? "block":"none";
}

function sendOrder(){
  const name = document.getElementById("name").value;
  const city = document.getElementById("city").value;
  const address = document.getElementById("address").value;
  const phone = document.getElementById("phone").value;
  if(!name || !city || !address || !phone){ alert("الرجاء ملء جميع الحقول"); return; }
  const order = {
    name, city, address, phone,
    products: cart,
    total: cart.reduce((sum,i)=>sum+i.qty*parseInt(i.price.replace(/,/g,"").replace(" ل.س","")),0)
  };
  tg.sendData(JSON.stringify(order));
  alert("✅ تم إرسال الطلب!");
  cart=[]; updateCartCount(); renderProducts();
  toggleCheckout();
}

// تهيئة
renderProducts();
